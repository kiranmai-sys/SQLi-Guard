{% extends "base.html" %}

{% block title %}Admin Dashboard - SQLi Guard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<div class="dashboard-container">
    <!-- Hero Section -->
    <div class="dashboard-hero">
        <div class="hero-content">
            <div class="hero-icon" aria-hidden="true">ğŸ›¡ï¸</div>
            <h1 class="hero-title">Admin Dashboard</h1>
            <p class="hero-subtitle">Security monitoring and system management</p>
            <div class="hero-stats">
                <div class="stat-card">
                    <div class="stat-number">3</div>
                    <div class="stat-label">Security Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">2</div>
                    <div class="stat-label">Schedules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">4</div>
                    <div class="stat-label">Users</div>
                </div>
            </div>
        </div>
        <div class="hero-background"></div>
    </div>

    <!-- Navigation Pills -->
    <div class="nav-pills" role="navigation">
        <a href="#security-section" class="nav-pill active" data-section="security" aria-current="true">
            <span class="pill-icon">ğŸš¨</span>
            <span class="pill-text">Security Events</span>
        </a>
        <a href="#schedules-section" class="nav-pill" data-section="schedules">
            <span class="pill-icon">ğŸ“…</span>
            <span class="pill-text">Schedules</span>
        </a>
        <a href="#users-section" class="nav-pill" data-section="users">
            <span class="pill-icon">ğŸ‘¥</span>
            <span class="pill-text">User Management</span>
        </a>
    </div>

    <!-- Security Events Section -->
    <section id="security-section" class="dashboard-section" aria-live="polite">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">ğŸš¨</span>
                <h2>Recent Security Events</h2>
            </div>
            <div class="section-badge">3 events</div>
        </div>
        
        <div class="section-content">
            <div class="loading-state" id="security-loading"></div>
            {% if security_events %}
            <div class="events-grid">
                {% for event in security_events %}
                <div class="event-card" style="animation: fadeIn 0.5s ease-in-out {{ loop.index0 * 0.1 }}s both;">
                    <div class="event-header">
                        <div class="event-type">{{ event.reason }}</div>
                        <div class="event-time">{{ event.ts }}</div>
                    </div>
                    <div class="event-details">
                        <div class="event-row">
                            <span class="event-label">IP Address:</span>
                            <span class="event-value ip-address">{{ event.ip }}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Username:</span>
                            <span class="event-value">{{ event.username or 'N/A' }}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Pattern:</span>
                            <span class="event-value code-snippet">{{ event.snippet[:50] }}{% if event.snippet|length > 50 %}...{% endif %}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">User Agent:</span>
                            <span class="event-value user-agent">{{ event.user_agent[:40] }}{% if event.user_agent|length > 40 %}...{% endif %}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <!-- Sample Data for Testing -->
            <div class="events-grid">
                <div class="event-card" style="animation: fadeIn 0.5s ease-in-out 0s both;">
                    <div class="event-header">
                        <div class="event-type">SQL Injection Attempt</div>
                        <div class="event-time">2025-09-18 07:00:00</div>
                    </div>
                    <div class="event-details">
                        <div class="event-row">
                            <span class="event-label">IP Address:</span>
                            <span class="event-value ip-address">192.168.1.1</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Username:</span>
                            <span class="event-value">test_user</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Pattern:</span>
                            <span class="event-value code-snippet">SELECT * FROM users</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">User Agent:</span>
                            <span class="event-value user-agent">Mozilla/5.0</span>
                        </div>
                    </div>
                </div>
                <div class="event-card" style="animation: fadeIn 0.5s ease-in-out 0.1s both;">
                    <div class="event-header">
                        <div class="event-type">XSS Attempt</div>
                        <div class="event-time">2025-09-18 07:05:00</div>
                    </div>
                    <div class="event-details">
                        <div class="event-row">
                            <span class="event-label">IP Address:</span>
                            <span class="event-value ip-address">192.168.1.2</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Username:</span>
                            <span class="event-value">N/A</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Pattern:</span>
                            <span class="event-value code-snippet">&lt;script&gt;alert('hack')&lt;/script&gt;</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">User Agent:</span>
                            <span class="event-value user-agent">Chrome/120.0</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Schedules Section -->
    <section id="schedules-section" class="dashboard-section" aria-live="polite">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">ğŸ“…</span>
                <h2>Schedule Management</h2>
            </div>
            <a href="{{ url_for('add_schedule') }}" class="action-btn primary" aria-label="Add a new schedule">
                <span class="btn-icon">â•</span>
                Add Schedule
            </a>
        </div>
        
        <div class="section-content">
            <div class="loading-state" id="schedules-loading"></div>
            {% if schedules %}
            <div class="schedules-grid">
                {% for schedule in schedules %}
                <div class="schedule-card" style="animation: fadeIn 0.5s ease-in-out {{ loop.index0 * 0.15 }}s both;">
                    <div class="schedule-header">
                        <div class="schedule-date">{{ schedule.date }}</div>
                        <div class="schedule-actions">
                            <a href="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" 
                               class="action-btn danger small"
                               onclick="return confirm('Are you sure you want to delete this schedule?')"
                               aria-label="Delete schedule">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                Delete
                            </a>
                        </div>
                    </div>
                    <div class="schedule-time">{{ schedule.start_time }} - {{ schedule.end_time }}</div>
                    <h3 class="schedule-title">{{ schedule.title }}</h3>
                    {% if schedule.description %}
                    <p class="schedule-description">{{ schedule.description }}</p>
                    {% endif %}
                    <div class="schedule-meta">
                        <span class="schedule-creator">Created by: {{ schedule.created_by_name }}</span>
                        <span class="schedule-timestamp">{{ schedule.created_at }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <!-- Sample Data for Testing -->
            <div class="schedules-grid">
                <div class="schedule-card" style="animation: fadeIn 0.5s ease-in-out 0s both;">
                    <div class="schedule-header">
                        <div class="schedule-date">2025-09-18</div>
                        <div class="schedule-actions">
                            <a href="#" class="action-btn danger small" onclick="return confirm('Are you sure you want to delete this schedule?')" aria-label="Delete schedule">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                Delete
                            </a>
                        </div>
                    </div>
                    <div class="schedule-time">09:00 - 10:00</div>
                    <h3 class="schedule-title">Security Review Meeting</h3>
                    <p class="schedule-description">Review recent security events and mitigation strategies.</p>
                    <div class="schedule-meta">
                        <span class="schedule-creator">Created by: Admin</span>
                        <span class="schedule-timestamp">2025-09-18 06:00:00</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Users Section -->
    <section id="users-section" class="dashboard-section" aria-live="polite">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">ğŸ‘¥</span>
                <h2>User Management</h2>
            </div>
            <div class="section-badge">4 users</div>
        </div>
        
        <div class="section-content">
            <div class="loading-state" id="users-loading"></div>
            {% if users %}
            <div class="users-grid">
                {% for user in users %}
                <div class="user-card" style="animation: fadeIn 0.5s ease-in-out {{ loop.index0 * 0.1 }}s both;">
                    <div class="user-avatar">
                        <span class="avatar-text">{{ user.username[0]|upper }}</span>
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">{{ user.username }}</h3>
                        <div class="user-role">
                            {% if user.role == 'admin' %}
                                <span class="role-badge admin">ğŸ›¡ï¸ Admin</span>
                            {% else %}
                                <span class="role-badge user">ğŸ‘¤ User</span>
                            {% endif %}
                        </div>
                        <div class="user-meta">
                            <span class="user-id">ID: {{ user.id }}</span>
                            <span class="user-created">{{ user.created_at }}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        {% if user.role != 'admin' %}
                            <a href="{{ url_for('delete_user', user_id=user.id) }}" 
                               class="action-btn danger small"
                               onclick="return confirm('Are you sure you want to delete user {{ user.username }}?')"
                               aria-label="Delete user {{ user.username }}">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                Delete
                            </a>
                        {% else %}
                            <span class="protected-badge">ğŸ”’ Protected</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <!-- Sample Data for Testing -->
            <div class="users-grid">
                <div class="user-card" style="animation: fadeIn 0.5s ease-in-out 0s both;">
                    <div class="user-avatar">
                        <span class="avatar-text">A</span>
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">admin</h3>
                        <div class="user-role">
                            <span class="role-badge admin">ğŸ›¡ï¸ Admin</span>
                        </div>
                        <div class="user-meta">
                            <span class="user-id">ID: 1</span>
                            <span class="user-created">2025-09-18 05:00:00</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <span class="protected-badge">ğŸ”’ Protected</span>
                    </div>
                </div>
                <div class="user-card" style="animation: fadeIn 0.5s ease-in-out 0.1s both;">
                    <div class="user-avatar">
                        <span class="avatar-text">J</span>
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">john_doe</h3>
                        <div class="user-role">
                            <span class="role-badge user">ğŸ‘¤ User</span>
                        </div>
                        <div class="user-meta">
                            <span class="user-id">ID: 2</span>
                            <span class="user-created">2025-09-18 05:30:00</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <a href="#" class="action-btn danger small" onclick="return confirm('Are you sure you want to delete user john_doe?')" aria-label="Delete user john_doe">
                            <span class="btn-icon">ğŸ—‘ï¸</span>
                            Delete
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Scroll to Top Button -->
<button id="scrollToTop" class="scroll-to-top" aria-label="Scroll to top">
    <span>â†‘</span>
</button>

<script>
// Smooth scrolling for navigation pills
document.querySelectorAll('.nav-pill').forEach(pill => {
    pill.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        this.setAttribute('aria-current', 'true');
        document.querySelectorAll('.nav-pill').forEach(p => {
            if (p !== this) p.setAttribute('aria-current', 'false');
        });
        
        const targetId = this.getAttribute('href');
        const targetSection = document.querySelector(targetId);
        if (targetSection) {
            targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

// Update active pill on scroll
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.dashboard-section');
    const pills = document.querySelectorAll('.nav-pill');
    
    let current = '';
    sections.forEach(section => {
        const sectionTop = section.offsetTop - 200;
        if (window.scrollY >= sectionTop) {
            current = section.getAttribute('id');
        }
    });
    
    pills.forEach(pill => {
        pill.classList.remove('active');
        pill.setAttribute('aria-current', 'false');
        if (pill.getAttribute('href') === '#' + current) {
            pill.classList.add('active');
            pill.setAttribute('aria-current', 'true');
        }
    });
});

// Scroll to top functionality
const scrollToTopBtn = document.getElementById('scrollToTop');
window.addEventListener('scroll', function() {
    scrollToTopBtn.classList.toggle('visible', window.scrollY > 300);
});

scrollToTopBtn.addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Simulate loading state (remove after 2 seconds)
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        document.querySelectorAll('.loading-state').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.section-content > *:not(.loading-state)').forEach(el => {
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
        });
    }, 2000);
});
</script>
{% endblock %}