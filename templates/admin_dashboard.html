{% extends "base.html" %}

{% block title %}Admin Dashboard - SQLi Guard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>üõ°Ô∏è Admin Dashboard</h2>
        <p>Security monitoring and schedule management</p>
    </div>
    
    <div class="dashboard-tabs">
        <button class="tab-button active" onclick="showTab(event, 'security')">Security Events</button>
        <button class="tab-button" onclick="showTab(event, 'schedules')">Schedules</button>
        <button class="tab-button" onclick="showTab(event, 'users')">User Management</button>
    </div>
    
    <!-- Security Events Tab -->
    <div id="security-tab" class="tab-content active">
        <div class="section-header">
            <h3>üö® Recent Security Events</h3>
            <span class="event-count">{{ security_events|length }} events</span>
        </div>
        
        <div class="events-table-container">
            {% if security_events %}
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>Username</th>
                        <th>Threat Type</th>
                        <th>Snippet</th>
                        <th>User Agent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in security_events %}
                    <tr>
                        <td class="timestamp">{{ event.ts }}</td>
                        <td class="ip-address">{{ event.ip }}</td>
                        <td class="username">{{ event.username or 'N/A' }}</td>
                        <td class="threat-type">{{ event.reason }}</td>
                        <td class="snippet">{{ event.snippet[:50] }}{% if event.snippet|length > 50 %}...{% endif %}</td>
                        <td class="user-agent">{{ event.user_agent[:30] }}{% if event.user_agent|length > 30 %}...{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-events">
                <div class="no-events-icon">‚úÖ</div>
                <h4>No Security Events</h4>
                <p>All systems secure - no threats detected recently.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Schedules Tab -->
    <div id="schedules-tab" class="tab-content">
        <div class="section-header">
            <h3>üìÖ Schedule Management</h3>
            <a href="{{ url_for('add_schedule') }}" class="btn btn-primary">Add New Schedule</a>
        </div>
        
        <div class="schedules-grid">
            {% if schedules %}
                {% for schedule in schedules %}
                <div class="admin-schedule-card">
                    <div class="schedule-header">
                        <div class="schedule-date">{{ schedule.date }}</div>
                        <div class="schedule-actions">
                            <a href="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" 
                               class="btn btn-danger btn-small"
                               onclick="return confirm('Are you sure you want to delete this schedule?')">Delete</a>
                        </div>
                    </div>
                    <div class="schedule-time">{{ schedule.start_time }} - {{ schedule.end_time }}</div>
                    <h4 class="schedule-title">{{ schedule.title }}</h4>
                    {% if schedule.description %}
                    <p class="schedule-description">{{ schedule.description }}</p>
                    {% endif %}
                    <div class="schedule-meta">
                        <span>Created by: {{ schedule.created_by_name }}</span>
                        <span>{{ schedule.created_at }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-schedule">
                    <div class="no-schedule-icon">üìã</div>
                    <h4>No Schedules</h4>
                    <p>No schedules have been created yet.</p>
                    <a href="{{ url_for('add_schedule') }}" class="btn btn-primary">Create First Schedule</a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content">
        <div class="section-header">
            <h3>üë• User Management</h3>
            <span class="event-count">{{ users|length }} users</span>
        </div>
        
        <div class="events-table-container">
            {% if users %}
            <table class="events-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="user-id">{{ user.id }}</td>
                        <td class="username">{{ user.username }}</td>
                        <td class="user-role">
                            {% if user.role == 'admin' %}
                                <span class="role-badge admin-role">Admin</span>
                            {% else %}
                                <span class="role-badge user-role">User</span>
                            {% endif %}
                        </td>
                        <td class="timestamp">{{ user.created_at }}</td>
                        <td class="user-actions">
                            {% if user.role != 'admin' %}
                                <a href="{{ url_for('delete_user', user_id=user.id) }}" 
                                   class="btn btn-danger btn-small"
                                   onclick="return confirm('Are you sure you want to delete user {{ user.username }}?')">Delete</a>
                            {% else %}
                                <span class="protected-user">Protected</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-events">
                <div class="no-events-icon">üë•</div>
                <h4>No Users Found</h4>
                <p>No users have been created yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function showTab(evt, tabName) {
    // Hide all tab contents
    var tabcontent = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove('active');
        tabcontent[i].style.display = "none";
    }
    
    // Remove active class from all tab buttons
    var tablinks = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove('active');
    }
    
    // Show the selected tab and mark button as active
    document.getElementById(tabName + '-tab').style.display = "block";
    document.getElementById(tabName + '-tab').classList.add('active');
    evt.currentTarget.classList.add('active');
}

// Initialize tabs on page load
document.addEventListener('DOMContentLoaded', function() {
    // Hide all tab contents except the first one
    var tabcontent = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabcontent.length; i++) {
        tab.classList.remove('active');
        if (i === 0) {
            tabcontent[i].style.display = "block";
            tabcontent[i].classList.add('active');
        } else {
            tabcontent[i].style.display = "none";
        }
    }
    
    // Set first tab button as active
    var tablinks = document.getElementsByClassName("tab-button");
    if (tablinks.length > 0) {
        tablinks[0].classList.add('active');
    }
});
</script>
{% endblock %}
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}
</script>
{% endblock %}