{% extends "base.html" %}

{% block title %}Admin Dashboard - SQLi Guard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Hero Section -->
    <div class="dashboard-hero">
        <div class="hero-content">
            <div class="hero-icon">🛡️</div>
            <h1 class="hero-title">Admin Dashboard</h1>
            <p class="hero-subtitle">Security monitoring and system management</p>
            <div class="hero-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ security_events|length }}</div>
                    <div class="stat-label">Security Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ schedules|length }}</div>
                    <div class="stat-label">Schedules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ users|length }}</div>
                    <div class="stat-label">Users</div>
                </div>
            </div>
        </div>
        <div class="hero-background"></div>
    </div>

    <!-- Navigation Pills -->
    <div class="nav-pills">
        <a href="#security-section" class="nav-pill active" data-section="security">
            <span class="pill-icon">🚨</span>
            <span class="pill-text">Security Events</span>
        </a>
        <a href="#schedules-section" class="nav-pill" data-section="schedules">
            <span class="pill-icon">📅</span>
            <span class="pill-text">Schedules</span>
        </a>
        <a href="#users-section" class="nav-pill" data-section="users">
            <span class="pill-icon">👥</span>
            <span class="pill-text">User Management</span>
        </a>
    </div>

    <!-- Security Events Section -->
    <section id="security-section" class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">🚨</span>
                <h2>Recent Security Events</h2>
            </div>
            <div class="section-badge">{{ security_events|length }} events</div>
        </div>
        
        <div class="section-content">
            {% if security_events %}
            <div class="events-grid">
                {% for event in security_events %}
                <div class="event-card" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
                    <div class="event-header">
                        <div class="event-type">{{ event.reason }}</div>
                        <div class="event-time">{{ event.ts }}</div>
                    </div>
                    <div class="event-details">
                        <div class="event-row">
                            <span class="event-label">IP Address:</span>
                            <span class="event-value ip-address">{{ event.ip }}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Username:</span>
                            <span class="event-value">{{ event.username or 'N/A' }}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">Pattern:</span>
                            <span class="event-value code-snippet">{{ event.snippet[:50] }}{% if event.snippet|length > 50 %}...{% endif %}</span>
                        </div>
                        <div class="event-row">
                            <span class="event-label">User Agent:</span>
                            <span class="event-value user-agent">{{ event.user_agent[:40] }}{% if event.user_agent|length > 40 %}...{% endif %}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" data-aos="fade-up">
                <div class="empty-icon">✅</div>
                <h3>No Security Events</h3>
                <p>All systems secure - no threats detected recently.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Schedules Section -->
    <section id="schedules-section" class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">📅</span>
                <h2>Schedule Management</h2>
            </div>
            <a href="{{ url_for('add_schedule') }}" class="action-btn primary">
                <span class="btn-icon">➕</span>
                Add Schedule
            </a>
        </div>
        
        <div class="section-content">
            {% if schedules %}
            <div class="schedules-grid">
                {% for schedule in schedules %}
                <div class="schedule-card" data-aos="slide-up" data-aos-delay="{{ loop.index0 * 150 }}">
                    <div class="schedule-header">
                        <div class="schedule-date">{{ schedule.date }}</div>
                        <div class="schedule-actions">
                            <a href="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" 
                               class="action-btn danger small"
                               onclick="return confirm('Are you sure you want to delete this schedule?')">
                                <span class="btn-icon">🗑️</span>
                                Delete
                            </a>
                        </div>
                    </div>
                    <div class="schedule-time">{{ schedule.start_time }} - {{ schedule.end_time }}</div>
                    <h3 class="schedule-title">{{ schedule.title }}</h3>
                    {% if schedule.description %}
                    <p class="schedule-description">{{ schedule.description }}</p>
                    {% endif %}
                    <div class="schedule-meta">
                        <span class="schedule-creator">Created by: {{ schedule.created_by_name }}</span>
                        <span class="schedule-timestamp">{{ schedule.created_at }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" data-aos="fade-up">
                <div class="empty-icon">📋</div>
                <h3>No Schedules</h3>
                <p>No schedules have been created yet.</p>
                <a href="{{ url_for('add_schedule') }}" class="action-btn primary">Create First Schedule</a>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Users Section -->
    <section id="users-section" class="dashboard-section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">👥</span>
                <h2>User Management</h2>
            </div>
            <div class="section-badge">{{ users|length }} users</div>
        </div>
        
        <div class="section-content">
            {% if users %}
            <div class="users-grid">
                {% for user in users %}
                <div class="user-card" data-aos="zoom-in" data-aos-delay="{{ loop.index0 * 100 }}">
                    <div class="user-avatar">
                        <span class="avatar-text">{{ user.username[0]|upper }}</span>
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">{{ user.username }}</h3>
                        <div class="user-role">
                            {% if user.role == 'admin' %}
                                <span class="role-badge admin">🛡️ Admin</span>
                            {% else %}
                                <span class="role-badge user">👤 User</span>
                            {% endif %}
                        </div>
                        <div class="user-meta">
                            <span class="user-id">ID: {{ user.id }}</span>
                            <span class="user-created">{{ user.created_at }}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        {% if user.role != 'admin' %}
                            <a href="{{ url_for('delete_user', user_id=user.id) }}" 
                               class="action-btn danger small"
                               onclick="return confirm('Are you sure you want to delete user {{ user.username }}?')">
                                <span class="btn-icon">🗑️</span>
                                Delete
                            </a>
                        {% else %}
                            <span class="protected-badge">🔒 Protected</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" data-aos="fade-up">
                <div class="empty-icon">👥</div>
                <h3>No Users Found</h3>
                <p>No users have been created yet.</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Scroll to Top Button -->
<button id="scrollToTop" class="scroll-to-top">
    <span>↑</span>
</button>

<script>
// Smooth scrolling for navigation pills
document.querySelectorAll('.nav-pill').forEach(pill => {
    pill.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all pills
        document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
        
        // Add active class to clicked pill
        this.classList.add('active');
        
        // Smooth scroll to section
        const targetId = this.getAttribute('href');
        const targetSection = document.querySelector(targetId);
        
        if (targetSection) {
            targetSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Update active pill on scroll
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.dashboard-section');
    const pills = document.querySelectorAll('.nav-pill');
    
    let current = '';
    
    sections.forEach(section => {
        const sectionTop = section.offsetTop - 200;
        const sectionHeight = section.offsetHeight;
        
        if (window.scrollY >= sectionTop && window.scrollY < sectionTop + sectionHeight) {
            current = section.getAttribute('id');
        }
    });
    
    pills.forEach(pill => {
        pill.classList.remove('active');
        if (pill.getAttribute('href') === '#' + current) {
            pill.classList.add('active');
        }
    });
});

// Scroll to top functionality
const scrollToTopBtn = document.getElementById('scrollToTop');

window.addEventListener('scroll', function() {
    if (window.scrollY > 300) {
        scrollToTopBtn.classList.add('visible');
    } else {
        scrollToTopBtn.classList.remove('visible');
    }
});

scrollToTopBtn.addEventListener('click', function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

// Initialize AOS (Animate On Scroll) library
document.addEventListener('DOMContentLoaded', function() {
    // Simple animation on scroll implementation
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);
    
    // Observe all animated elements
    document.querySelectorAll('[data-aos]').forEach(el => {
        observer.observe(el);
    });
});
</script>
{% endblock %}